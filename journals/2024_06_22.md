- 今天处理了一次 [[MySQL]] [[数据库]] [[连接池]] 的 [[故障]]，记录一下
	- 首先提一下架构，客户端是druid连接池，数据库是 MySQL，然后中间用  HAProxy  做了下主备（以前一直以为是多主，搞笑了）。
	- 先说结论——**HAProxy的超时配置问题，导致其自顾自地把连接关闭了**（或者做了某种负载均衡，让端口漂移了之类的），而**客户端和数据库均不知道其关闭了**，这就导致：
		- 客户端不知道连接被关闭了，然后使用该连接时报连接失败，客户端便丢弃该连接，创建新连接
		  logseq.order-list-type:: number
		- MySQL不知道连接被关闭了，结果数据库中有大量时间很长的状态为`Sleep`的连接
		  logseq.order-list-type:: number
		- 连接数量不断增加，直到达到数据库的连接数量上限 `max_connections`
		  logseq.order-list-type:: number
	- 首先遇到的问题是前端反应慢，然后控制台有报错弹出来：
		- ![image.png](../assets/image_1719053194254_0.png)
		- 这个错误是说，**客户端到数据库的连接关闭了，而客户端以为该连接未关闭**，同时这里展示了上一次发送和收到包的时间。
	- 和数据库连接
	-
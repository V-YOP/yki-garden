- 今天处理了一次 [[MySQL]] [[数据库]] [[连接池]] 的 [[故障]]，记录一下
	- 首先提一下架构，客户端是druid连接池，数据库是 [[MySQL]]，然后中间用  HAProxy  做了下主备（以前一直以为是多主，搞笑了）。
	- 先说结论——**HAProxy的超时配置问题，导致其自顾自地把连接关闭了**（或者做了某种负载均衡，让端口漂移了之类的），而**客户端和数据库均不知道其关闭了**，这就导致：
		- 客户端不知道连接被关闭了，然后使用该连接时报连接失败，客户端便丢弃该连接，创建新连接
		  logseq.order-list-type:: number
		- MySQL不知道连接被关闭了，结果数据库中有大量时间很长的状态为`Sleep`的连接
		  logseq.order-list-type:: number
		- 连接数量不断增加，直到达到数据库的连接数量上限 `max_connections`，后续再创建连接便会报错`Too many connections`，彻底停摆。
		  logseq.order-list-type:: number
	- 最后问题仍未解决，配置HAProxy（我没参与所以不清楚细节）的超时时间后状况似乎有缓解，但仍旧马上又出问题。最终无果只得丢弃HAProxy，直连数据库，此后问题消失，后续考虑换掉HAProxy。
	- ---
	- 首先遇到的问题是前端反应慢，然后控制台有报错弹出来：
		- ![image.png](../assets/image_1719053194254_0.png)
		- 这个错误是说，**客户端到数据库的连接关闭了，而客户端以为该连接未关闭**，同时这里展示了上一次发送和收到包的时间。
	- 然后，系统开始变得无法访问：
		- ![dce602ce3da63f6f7230b485c589ccb.png](../assets/dce602ce3da63f6f7230b485c589ccb_1719053738273_0.png)
	- 中途解决问题时，有以下过程：
		- 首先怀疑是一处异步调用的地方的问题，一个异步操作中取调用了一个外部API去设置一个值然后插入到数据库，但该API在生产时无法访问，结果每次调用时都会卡住直到超时（tmd 60秒，YBB），同时这里
	-